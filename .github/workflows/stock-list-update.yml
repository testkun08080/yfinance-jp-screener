name: ğŸ“‹ Stock List Update

permissions:
  contents: write
  actions: read

on:
  workflow_dispatch:
    inputs:
      market:
        description: "å¸‚å ´ (æ—¥æœ¬æ ª=JP / ç±³å›½æ ª=US)"
        required: true
        default: "JP"
        type: choice
        options:
          - "JP"
          - "US"
      reason:
        description: "Update reason (optional)"
        required: false
        default: "Manual stock list update"
        type: string

jobs:
  update-stock-list:
    runs-on: ubuntu-latest
    env:
      SEC_USER_AGENT_CONTACT: ${{ secrets.SEC_USER_AGENT_CONTACT }}

    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ğŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r stock_list/requirements.txt

      - name: ğŸ“‹ Show input parameters
        run: |
          echo "Market: ${{ github.event.inputs.market }}"
          echo "Update reason: ${{ github.event.inputs.reason }}"
          echo "Timestamp: $(date)"
          echo "Working directory: $(pwd)"
          ls -la stock_list/

      - name: ğŸ” Check SEC_USER_AGENT_CONTACT (required for US)
        if: github.event.inputs.market == 'US'
        run: |
          if [ -z "${{ secrets.SEC_USER_AGENT_CONTACT }}" ]; then
            echo "::error::ç±³å›½æ ªãƒªã‚¹ãƒˆå–å¾—ã«ã¯ SEC_USER_AGENT_CONTACT ãŒå¿…è¦ã§ã™ã€‚"
            echo "ãƒªãƒã‚¸ãƒˆãƒªã® Settings â†’ Secrets and variables â†’ Actions ã§ SEC_USER_AGENT_CONTACT ã‚’è¿½åŠ ã—ã€ã‚ãªãŸã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚"
            echo "å‚è€ƒ: https://www.sec.gov/os/accessing-edgar-data"
            exit 1
          fi
          echo "âœ… SEC_USER_AGENT_CONTACT ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"

      - name: ğŸŒ Fetch latest stock list
        working-directory: ./stock_list
        run: |
          MARKET="${{ github.event.inputs.market }}"
          echo "ğŸš€ Starting stock list download (market=$MARKET)..."
          echo "Timestamp: $(date)"

          if [ "$MARKET" = "US" ]; then
            python get_us_stocklist.py
            MASTER=us_stocks_all.json
          else
            python get_jp_stocklist.py
            MASTER=stocks_all.json
          fi

          echo "âœ… Stock list download completed"
          if [ -f "$MASTER" ]; then
            echo "ğŸ“Š $MASTER created successfully"
            echo "File size: $(ls -lh "$MASTER" | awk '{print $5}')"
            echo "Total companies: $(cat "$MASTER" | jq length)"
          else
            echo "âŒ Error: $MASTER not found"
            exit 1
          fi

      - name: âœ‚ï¸ Split into chunks
        working-directory: ./stock_list
        run: |
          MARKET="${{ github.event.inputs.market }}"
          echo "ğŸ”€ Starting stock list splitting (market=$MARKET)..."
          echo "Timestamp: $(date)"

          if [ "$MARKET" = "US" ]; then
            python split_stocks.py --input us_stocks_all.json --size 1000
            PREFIX=us_stocks_
          else
            python split_stocks.py --input stocks_all.json --size 1000
            PREFIX=stocks_
          fi

          echo "âœ… Splitting completed"
          echo "ğŸ“„ Generated files:"
          ls -la ${PREFIX}*.json 2>/dev/null || true

          echo "ğŸ” Verifying split files..."
          for file in ${PREFIX}[0-9]*.json; do
            if [ -f "$file" ]; then
              companies=$(cat "$file" | jq length 2>/dev/null)
              if [ $? -eq 0 ]; then
                echo "âœ… $file: $companies companies (Valid JSON)"
              else
                echo "âŒ $file: Invalid JSON format"
                exit 1
              fi
            fi
          done

      - name: ğŸ“Š Generate update summary
        working-directory: ./stock_list
        run: |
          MARKET="${{ github.event.inputs.market }}"
          if [ "$MARKET" = "US" ]; then
            MASTER=us_stocks_all.json
            PREFIX=us_stocks_
            REPORT=us_stock_list_update_report.md
            TITLE="US Stock List Update Report"
          else
            MASTER=stocks_all.json
            PREFIX=stocks_
            REPORT=stock_list_update_report.md
            TITLE="Stock List Update Report"
          fi

          echo "# ğŸ“‹ $TITLE" > "$REPORT"
          echo "" >> "$REPORT"
          echo "**Market:** $MARKET" >> "$REPORT"
          echo "**Generated:** $(date)" >> "$REPORT"
          echo "**Reason:** ${{ github.event.inputs.reason }}" >> "$REPORT"
          echo "**Workflow:** ${{ github.workflow }}" >> "$REPORT"
          echo "" >> "$REPORT"

          if [ -f "$MASTER" ]; then
            total_companies=$(cat "$MASTER" | jq length)
            size=$(ls -lh "$MASTER" | awk '{print $5}')
            echo "## ğŸ“Š Master List" >> "$REPORT"
            echo "- **File:** $MASTER" >> "$REPORT"
            echo "- **Size:** $size" >> "$REPORT"
            echo "- **Total Companies:** $total_companies" >> "$REPORT"
            echo "" >> "$REPORT"
          fi

          echo "## ğŸ“‚ Split Files" >> "$REPORT"
          echo "" >> "$REPORT"
          for file in ${PREFIX}[0-9]*.json; do
            if [ -f "$file" ]; then
              size=$(ls -lh "$file" | awk '{print $5}')
              count=$(cat "$file" | jq length)
              echo "- **$file** - Size: $size, Companies: $count" >> "$REPORT"
            fi
          done

          echo "" >> "$REPORT"
          echo "## ğŸ¤– Automation Info" >> "$REPORT"
          echo "- **GitHub Action:** [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> "$REPORT"
          echo "- **Commit SHA:** ${{ github.sha }}" >> "$REPORT"
          echo "- **Repository:** ${{ github.repository }}" >> "$REPORT"

      - name: ğŸ”§ Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: ğŸ’¾ Commit and push changes
        run: |
          MARKET="${{ github.event.inputs.market }}"
          if [ "$MARKET" = "US" ]; then
            git add stock_list/us_stocks_*.json
            git add stock_list/us_stock_list_update_report.md
            LABEL="ç±³å›½æ ªå¼"
          else
            git add stock_list/stocks_*.json
            git add stock_list/stock_list_update_report.md
            LABEL="æ—¥æœ¬æ ªå¼"
          fi

          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            CURRENT_DATE=$(date '+%Yå¹´%mæœˆ%dæ—¥')
            git commit -m "ğŸ“‹ ${LABEL}ã®ãƒªã‚¹ãƒˆã‚’æ›´æ–°($CURRENT_DATE)

            - å¸‚å ´: $MARKET
            - æ›´æ–°ç†ç”±: ${{ github.event.inputs.reason }}
            - å®Ÿè¡Œæ—¥æ™‚: $(date)
            - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: ${{ github.workflow }}

            ğŸ¤– Generated by GitHub Action"

            git push
            echo "âœ… Changes committed and pushed successfully"
          fi

      - name: ğŸ“ˆ Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: stock-list-update-${{ github.event.inputs.market }}-$(date +%Y%m%d-%H%M%S)
          path: |
            stock_list/stocks_*.json
            stock_list/stock_list_update_report.md
            stock_list/us_stocks_*.json
            stock_list/us_stock_list_update_report.md
          retention-days: 30
