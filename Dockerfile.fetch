# Python Data Collection Service Dockerfile
# 株式データ収集サービス用Dockerfile

FROM python:3.11-slim

# 作業ディレクトリ設定
WORKDIR /app

# システムパッケージ更新と必要なツールをインストール
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Pythonの依存関係をコピーしてインストール
COPY stock_list/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 株式データ処理スクリプトをコピー
COPY stock_list/*.py ./
COPY stock_list/run_fetch.sh ./
COPY stock_list/stocks_sample.json ./

# データディレクトリを作成
RUN mkdir -p Export

# 非rootユーザーで実行
RUN useradd -m -u 1000 stockuser && \
    chown -R stockuser:stockuser /app && \
    chmod +x /app/run_fetch.sh
USER stockuser

# 環境変数: MARKET=JP|US, STOCK_FILE未指定時は stocks_1.json(JP) / us_stocks_1.json(US)
ENV MARKET=JP
ENV CHUNK_SIZE=1000

# デフォルトコマンド（run_fetch.sh が市場に応じてリスト取得→分割→収集→結合）
CMD ["sh", "./run_fetch.sh"]