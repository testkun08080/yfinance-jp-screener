name: ğŸ“‹ CSV Combine & Export

permissions:
  contents: write
  actions: read

on:
  workflow_dispatch:
    inputs:
      custom_date:
        description: "å¯¾è±¡æ—¥ä»˜ (YYYYMMDDå½¢å¼ã€ç©ºç™½ã®å ´åˆã¯ä»Šæ—¥ã®æ—¥ä»˜)"
        required: false
        default: ""
        type: string
      reason:
        description: "CSVçµåˆã®ç†ç”±"
        required: false
        default: "Latest CSV files combination"
        type: string

jobs:
  combine-csv:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ğŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas

      - name: ğŸ“‹ Show input parameters
        run: |
          echo "Target date: ${{ github.event.inputs.custom_date || 'today' }}"
          echo "Reason: ${{ github.event.inputs.reason || 'Auto-triggered after deployment' }}"
          echo "Working directory: $(pwd)"
          echo "Current CSV files in Export directory:"
          ls -la stock_list/Export/ 2>/dev/null || echo "No files in Export directory"

      - name: ğŸ” Check existing CSV files
        working-directory: ./stock_list
        run: |
          echo "ğŸ“„ Existing CSV files:"
          find Export/ -name "japanese_stocks_data_*.csv" -type f | sort -r | head -10 || echo "No CSV files found"
          echo ""
          echo "ğŸ“Š File statistics:"
          find Export/ -name "japanese_stocks_data_*.csv" -type f -exec ls -lh {} \; | head -5 || echo "No files for statistics"

      - name: ğŸ”— Combine latest CSV files
        working-directory: ./stock_list
        run: |
          echo "ğŸš€ Starting CSV combination..."
          echo "Timestamp: $(date)"

          # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å¼•æ•°ã‚’æº–å‚™
          ARGS=""
          if [ -n "${{ github.event.inputs.custom_date }}" ]; then
            ARGS="--date ${{ github.event.inputs.custom_date }}"
            echo "Target date: ${{ github.event.inputs.custom_date }}"
          else
            echo "Target date: today ($(date +'%Y%m%d'))"
          fi

          echo "Arguments: $ARGS"

          # CSVçµåˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œï¼ˆæŒ‡å®šæ—¥ä»˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’çµåˆï¼‰
          python combine_latest_csv.py $ARGS

          echo "âœ… CSV combination completed"
          echo "ğŸ“„ Generated files:"
          ls -la Export/*_combined.csv 2>/dev/null || echo "No combined files generated"

      - name: ğŸ“Š Show combination results
        working-directory: ./stock_list
        run: |
          echo "ğŸ¯ Combination Results:"
          echo "===================="

          # çµåˆãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±è¡¨ç¤º
          for file in Export/*_combined.csv; do
            if [ -f "$file" ]; then
              echo "ğŸ“ File: $(basename "$file")"
              echo "ğŸ“ Size: $(ls -lh "$file" | awk '{print $5}')"
              echo "ğŸ“Š Lines: $(wc -l < "$file") rows"
              echo "ğŸ“… Modified: $(date -r "$file" '+%Y-%m-%d %H:%M:%S')"
              echo "--------------------"
            fi
          done

          # Export ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å…¨ä½“çŠ¶æ³
          echo ""
          echo "ğŸ“‚ Export Directory Status:"
          ls -lah Export/ | head -20

      - name: ğŸ”§ Git configuration
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull origin main --rebase || true

      - name: ğŸ’¾ Commit and push combined CSV
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            ğŸ“Š CSVçµåˆãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ ($(date +'%Yå¹´%mæœˆ%dæ—¥'))


