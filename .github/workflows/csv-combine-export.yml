name: ğŸ“‹ CSV Combine & Export

permissions:
  contents: write
  actions: read

on:
  workflow_dispatch:
    inputs:
      custom_date:
        description: "å¯¾è±¡æ—¥ä»˜ (YYYYMMDDå½¢å¼ã€ç©ºç™½ã®å ´åˆã¯ä»Šæ—¥ã®æ—¥ä»˜)"
        required: false
        default: ""
        type: string
      reason:
        description: "CSVçµåˆã®ç†ç”±"
        required: false
        default: "Latest CSV files combination"
        type: string
      market_type:
        description: "å¸‚å ´ (JP: æ—¥æœ¬æ ª, US: ç±³å›½æ ª, both: ä¸¡æ–¹)"
        required: false
        default: "JP"
        type: choice
        options:
          - "JP"
          - "US"
          - "both"

jobs:
  combine-csv:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ğŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas

      - name: ğŸ“‹ Show input parameters
        run: |
          echo "Target date: ${{ github.event.inputs.custom_date || 'today' }}"
          echo "Reason: ${{ github.event.inputs.reason || 'Auto-triggered after deployment' }}"
          echo "Market type: ${{ github.event.inputs.market_type || 'JP' }}"
          echo "Working directory: $(pwd)"
          echo "Current CSV files in Export directory:"
          ls -la stock_list/Export/ 2>/dev/null || echo "No files in Export directory"

      - name: ğŸ” Check existing CSV files
        working-directory: ./stock_list
        run: |
          echo "ğŸ“„ Existing CSV files (JP):"
          find Export/ -name "japanese_stocks_data_*.csv" -type f | sort -r | head -10 || echo "No JP CSV files found"
          echo ""
          echo "ğŸ“„ Existing CSV files (US):"
          find Export/ -name "us_stocks_data_*.csv" -type f | sort -r | head -10 || echo "No US CSV files found"
          echo ""
          echo "ğŸ“Š File statistics (JP):"
          find Export/ -name "japanese_stocks_data_*.csv" -type f -exec ls -lh {} \; | head -5 || true
          echo "ğŸ“Š File statistics (US):"
          find Export/ -name "us_stocks_data_*.csv" -type f -exec ls -lh {} \; | head -5 || true

      - name: ğŸ”— Combine latest CSV files
        working-directory: ./stock_list
        run: |
          # Security: read inputs once into variables; validate before use to prevent injection
          DATE_INPUT="${{ github.event.inputs.custom_date }}"
          MT="${{ github.event.inputs.market_type || 'JP' }}"

          echo "ğŸš€ Starting CSV combination (market_type=$MT)..."
          echo "Timestamp: $(date)"

          # Validate custom_date: if provided, must be exactly YYYYMMDD (8 digits)
          if [ -n "$DATE_INPUT" ]; then
            if ! echo "$DATE_INPUT" | grep -qE '^[0-9]{8}$'; then
              echo "âŒ Invalid custom_date: must be YYYYMMDD (8 digits), got: $DATE_INPUT"
              exit 1
            fi
            echo "Target date: $DATE_INPUT"
          else
            echo "Target date: today ($(date +'%Y%m%d'))"
          fi

          # Whitelist market_type (choice input already restricts; enforce in script)
          case "$MT" in
            JP|US|both) ;;
            *) echo "âš ï¸ Invalid market_type, defaulting to JP"; MT=JP ;;
          esac

          # Base args (date only); run combination per market so "both" produces JP + US files
          ARGS=()
          if [ -n "$DATE_INPUT" ]; then
            ARGS+=(--date "$DATE_INPUT")
          fi

          if [ "$MT" = "JP" ] || [ "$MT" = "both" ]; then
            echo "Combining JP market: ${ARGS[*]} --market-type JP"
            python combine_latest_csv.py "${ARGS[@]}" --market-type JP
          fi
          if [ "$MT" = "US" ] || [ "$MT" = "both" ]; then
            echo "Combining US market: ${ARGS[*]} --market-type US"
            python combine_latest_csv.py "${ARGS[@]}" --market-type US
          fi

          echo "âœ… CSV combination completed"
          echo "ğŸ“„ Generated files:"
          ls -la Export/*_combined.csv Export/*_jp_combined.csv Export/*_us_combined.csv 2>/dev/null || echo "No combined files generated"

      - name: ğŸ“Š Show combination results
        working-directory: ./stock_list
        run: |
          echo "ğŸ¯ Combination Results:"
          echo "===================="
          for file in Export/*_combined.csv Export/*_jp_combined.csv Export/*_us_combined.csv; do
            if [ -f "$file" ]; then
              echo "ğŸ“ File: $(basename "$file")"
              echo "ğŸ“ Size: $(ls -lh "$file" | awk '{print $5}')"
              echo "ğŸ“Š Lines: $(wc -l < "$file") rows"
              echo "ğŸ“… Modified: $(date -r "$file" '+%Y-%m-%d %H:%M:%S')"
              echo "--------------------"
            fi
          done
          echo "ğŸ“‚ Export Directory Status:"
          ls -lah Export/ | head -20

      - name: ğŸ”§ Git configuration
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull origin main --rebase || true

      - name: ğŸ’¾ Commit and push combined CSV
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            ğŸ“Š CSVçµåˆãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ ($(date +'%Yå¹´%mæœˆ%dæ—¥')) market=${{ github.event.inputs.market_type || 'JP' }}


