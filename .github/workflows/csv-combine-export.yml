name: 📋 CSV Combine & Export

permissions:
  contents: write
  actions: read

on:
  workflow_dispatch:
    inputs:
      custom_date:
        description: "対象日付 (YYYYMMDD形式、空白の場合は今日の日付)"
        required: false
        default: ""
        type: string
      reason:
        description: "CSV結合の理由"
        required: false
        default: "Latest CSV files combination"
        type: string

jobs:
  combine-csv:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
      - name: 🔄 Checkout repository
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: 📦 Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas

      - name: 📋 Show input parameters
        run: |
          echo "Target date: ${{ github.event.inputs.custom_date || 'today' }}"
          echo "Reason: ${{ github.event.inputs.reason || 'Auto-triggered after deployment' }}"
          echo "Working directory: $(pwd)"
          echo "Current CSV files in Export directory:"
          ls -la stock_list/Export/ 2>/dev/null || echo "No files in Export directory"

      - name: 🔍 Check existing CSV files
        working-directory: ./stock_list
        run: |
          echo "📄 Existing CSV files:"
          find Export/ -name "japanese_stocks_data_*.csv" -type f | sort -r | head -10 || echo "No CSV files found"
          echo ""
          echo "📊 File statistics:"
          find Export/ -name "japanese_stocks_data_*.csv" -type f -exec ls -lh {} \; | head -5 || echo "No files for statistics"

      - name: 🔗 Combine latest CSV files
        working-directory: ./stock_list
        run: |
          echo "🚀 Starting CSV combination..."
          echo "Timestamp: $(date)"

          # Pythonスクリプトの引数を準備
          ARGS=""
          if [ -n "${{ github.event.inputs.custom_date }}" ]; then
            ARGS="--date ${{ github.event.inputs.custom_date }}"
            echo "Target date: ${{ github.event.inputs.custom_date }}"
          else
            echo "Target date: today ($(date +'%Y%m%d'))"
          fi

          echo "Arguments: $ARGS"

          # CSV結合スクリプトを実行（指定日付のファイルのみを結合）
          python combine_latest_csv.py $ARGS

          echo "✅ CSV combination completed"
          echo "📄 Generated files:"
          ls -la Export/*_combined.csv 2>/dev/null || echo "No combined files generated"

      - name: 📊 Show combination results
        working-directory: ./stock_list
        run: |
          echo "🎯 Combination Results:"
          echo "===================="

          # 結合ファイルの情報表示
          for file in Export/*_combined.csv; do
            if [ -f "$file" ]; then
              echo "📁 File: $(basename "$file")"
              echo "📏 Size: $(ls -lh "$file" | awk '{print $5}')"
              echo "📊 Lines: $(wc -l < "$file") rows"
              echo "📅 Modified: $(date -r "$file" '+%Y-%m-%d %H:%M:%S')"
              echo "--------------------"
            fi
          done

          # Export ディレクトリの全体状況
          echo ""
          echo "📂 Export Directory Status:"
          ls -lah Export/ | head -20

      - name: 🔧 Git configuration
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull origin main --rebase || true

      - name: 💾 Commit and push combined CSV
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            📊 CSV結合ファイル生成 ($(date +'%Y年%m月%d日'))


